{% extends 'travel/base.html' %}
{% load static %}

{% block title %}Редактирование профиля - TravelLux{% endblock %}

{% block content %}
    <!-- Заголовок страницы -->
    <section class="hero" style="padding: 120px 0 60px;">
        <div class="container">
            <div class="hero-content">
                <h1>Редактирование профиля</h1>
                <p>Обновите информацию о себе</p>
            </div>
        </div>
    </section>

    <!-- Форма редактирования профиля -->
    <section class="section">
        <div class="container">
            <div class="grid grid-3">
                <!-- Текущий профиль -->
                <div class="card">
                    <div class="card-content text-center">
                        <h3 class="mb-3">Текущий профиль</h3>
                        {% if profile.avatar %}
                            <img src="{{ profile.avatar.url }}" alt="Avatar" class="avatar-preview">
                        {% else %}
                            <div class="avatar-placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                        {% endif %}
                        <h4 class="mt-3">{{ user.first_name|default:user.username }}</h4>
                        <p class="text-light">{{ user.email }}</p>
                        <div class="text-left mt-3">
                            <p><strong>Телефон:</strong> {{ profile.phone|default:"Не указан" }}</p>
                            {% if profile.birth_date %}
                                <p><strong>Дата рождения:</strong> {{ profile.birth_date }}</p>
                            {% endif %}
                            <p><strong>Регистрация:</strong> {{ user.date_joined|date:"d.m.Y" }}</p>
                        </div>
                    </div>
                </div>

                <!-- Форма редактирования -->
                <div style="grid-column: span 2;">
                    <div class="card">
                        <div class="card-content">
                            <h3 class="mb-4">Обновить информацию</h3>
                            
                            <form method="post" enctype="multipart/form-data" class="profile-form">
                                {% csrf_token %}
                                
                                <!-- Основная информация -->
                                <div class="form-section">
                                    <h4 class="mb-3">Основная информация</h4>
                                    <div class="grid grid-2" style="gap: 1rem;">
                                        <div class="form-group">
                                            <label for="{{ user_form.username.id_for_label }}">{{ user_form.username.label }}</label>
                                            {{ user_form.username }}
                                            {% if user_form.username.errors %}
                                                <div class="form-error">{{ user_form.username.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="{{ user_form.email.id_for_label }}">{{ user_form.email.label }}</label>
                                            {{ user_form.email }}
                                            {% if user_form.email.errors %}
                                                <div class="form-error">{{ user_form.email.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="{{ user_form.first_name.id_for_label }}">{{ user_form.first_name.label }}</label>
                                            {{ user_form.first_name }}
                                            {% if user_form.first_name.errors %}
                                                <div class="form-error">{{ user_form.first_name.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="{{ user_form.last_name.id_for_label }}">{{ user_form.last_name.label }}</label>
                                            {{ user_form.last_name }}
                                            {% if user_form.last_name.errors %}
                                                <div class="form-error">{{ user_form.last_name.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <hr style="margin: 2rem 0;">

                                <!-- Дополнительная информация -->
                                <div class="form-section">
                                    <h4 class="mb-3">Дополнительная информация</h4>
                                    <div class="grid grid-2" style="gap: 1rem;">
                                        <div class="form-group">
                                            <label for="{{ profile_form.phone.id_for_label }}">{{ profile_form.phone.label }}</label>
                                            {{ profile_form.phone }}
                                            {% if profile_form.phone.errors %}
                                                <div class="form-error">{{ profile_form.phone.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="{{ profile_form.birth_date.id_for_label }}">{{ profile_form.birth_date.label }}</label>
                                            {{ profile_form.birth_date }}
                                            {% if profile_form.birth_date.errors %}
                                                <div class="form-error">{{ profile_form.birth_date.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <hr style="margin: 2rem 0;">

                                <!-- Фото профиля -->
                                <div class="form-section">
                                    <h4 class="mb-3">Фото профиля</h4>
                                    <div class="avatar-upload-section">
                                        <div class="avatar-upload-preview">
                                            {% if profile.avatar %}
                                                <img src="{{ profile.avatar.url }}" alt="Avatar" id="avatar-preview" class="avatar-preview">
                                            {% else %}
                                                <div id="avatar-preview" class="avatar-placeholder">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="avatar-upload-controls">
                                            <div class="form-group">
                                                <label for="{{ profile_form.avatar.id_for_label }}">{{ profile_form.avatar.label }}</label>
                                                {{ profile_form.avatar }}
                                                <small class="form-text">{{ profile_form.avatar.help_text }}</small>
                                                {% if profile_form.avatar.errors %}
                                                    <div class="form-error">{{ profile_form.avatar.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="avatar-actions">
                                                <button type="button" class="btn btn-secondary" onclick="triggerFileInput()">
                                                    <i class="fas fa-upload"></i> Выбрать фото
                                                </button>
                                                {% if profile.avatar %}
                                                    <button type="button" class="btn btn-outline" onclick="removeAvatar()">
                                                        <i class="fas fa-trash"></i> Удалить
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Кнопки управления -->
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Сохранить изменения
                                    </button>
                                    <a href="{% url 'profile' %}" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> Отмена
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <style>
        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .avatar-placeholder {
            width: 120px;
            height: 120px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            border: 4px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .avatar-placeholder i {
            font-size: 50px;
            color: white;
        }
        
        .avatar-upload-section {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 2rem;
            align-items: start;
        }
        
        .avatar-upload-preview {
            text-align: center;
        }
        
        .avatar-upload-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .avatar-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .form-section {
            margin-bottom: 2rem;
        }
        
        .form-section h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .form-text {
            color: #6c757d;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: block;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
        }
        
        .btn-outline {
            background: transparent;
            color: #6c757d;
            border: 2px solid #6c757d;
        }
        
        .btn-outline:hover {
            background: #6c757d;
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .avatar-upload-section {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .form-actions {
                flex-direction: column;
            }
        }
    </style>

    <script>
        // Предварительный просмотр изображения
        document.getElementById('{{ profile_form.avatar.id_for_label }}').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('avatar-preview');
                    if (preview.tagName === 'IMG') {
                        preview.src = e.target.result;
                    } else {
                        // Заменяем placeholder на изображение
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'avatar-preview';
                        img.id = 'avatar-preview';
                        preview.parentNode.replaceChild(img, preview);
                    }
                };
                reader.readAsDataURL(file);
            }
        });
        
        function triggerFileInput() {
            document.getElementById('{{ profile_form.avatar.id_for_label }}').click();
        }
        
        function removeAvatar() {
            if (confirm('Вы уверены, что хотите удалить фото профиля?')) {
                // Создаем скрытое поле для отправки сигнала об удалении
                const form = document.querySelector('.profile-form');
                const removeField = document.createElement('input');
                removeField.type = 'hidden';
                removeField.name = 'remove_avatar';
                removeField.value = 'true';
                form.appendChild(removeField);
                
                // Заменяем изображение на placeholder
                const preview = document.getElementById('avatar-preview');
                const placeholder = document.createElement('div');
                placeholder.className = 'avatar-placeholder';
                placeholder.id = 'avatar-preview';
                placeholder.innerHTML = '<i class="fas fa-user"></i>';
                preview.parentNode.replaceChild(placeholder, preview);
                
                // Очищаем поле файла
                document.getElementById('{{ profile_form.avatar.id_for_label }}').value = '';
            }
        }
        
        // Валидация формы
        document.querySelector('.profile-form').addEventListener('submit', function(e) {
            const username = document.getElementById('{{ user_form.username.id_for_label }}').value.trim();
            const email = document.getElementById('{{ user_form.email.id_for_label }}').value.trim();
            
            if (!username) {
                alert('Имя пользователя обязательно для заполнения');
                e.preventDefault();
                return;
            }
            
            if (!email) {
                alert('Email обязателен для заполнения');
                e.preventDefault();
                return;
            }
            
            // Валидация email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Введите корректный email адрес');
                e.preventDefault();
                return;
            }
        });
        
        // Анимация появления формы
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>
{% endblock %}